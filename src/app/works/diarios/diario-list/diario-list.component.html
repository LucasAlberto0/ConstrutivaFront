<div class="diario-list-container">
  <h2>Diário de Obra</h2>

  <div *ngIf="loading" class="loading-message">Processando...</div>

  <div *ngIf="canManageDiarios" class="card diario-form">
    <h3>Adicionar Novo Diário</h3>
    <form (ngSubmit)="addDiario()">
      <div class="form-group">
        <label for="data">Data</label>
        <input type="date" id="data" name="data" [(ngModel)]="newDiario.data" required>
      </div>
      <div class="form-group">
        <label for="clima">Clima</label>
        <select id="clima" name="clima" [(ngModel)]="newDiario.clima" required>
          <option *ngFor="let climaOption of climaOptions" [value]="climaOption">{{ climaOption }}</option>
        </select>
      </div>
      <div class="form-group">
        <label for="quantidadeColaboradores">Quantidade de Colaboradores</label>
        <input type="number" id="quantidadeColaboradores" name="quantidadeColaboradores" [(ngModel)]="newDiario.quantidadeColaboradores">
      </div>
      <div class="form-group">
        <label for="descricaoAtividades">Descrição das Atividades</label>
        <textarea id="descricaoAtividades" name="descricaoAtividades" [(ngModel)]="newDiario.descricaoAtividades" required></textarea>
      </div>
      <div class="form-group">
        <label for="observacoes">Observações (Opcional)</label>
        <textarea id="observacoes" name="observacoes" [(ngModel)]="newDiario.observacoes"></textarea>
      </div>
      <div class="form-group">
        <label for="foto">Foto (Opcional)</label>
        <div class="file-input-wrapper">
          <input type="file" id="foto" name="foto" (change)="onFileSelected($event)" #fileInput hidden>
          <button type="button" class="custom-file-button" (click)="fileInput.click()"><img src="img/uploadIcon.svg" alt=""> Escolher Arquivo</button>
          <span class="file-name">{{ newDiario.foto ? newDiario.foto.name : 'Nenhum arquivo selecionado' }}</span>
        </div>
      </div>
      <button type="submit" class="btn-primary"><img src="img/plusIcon.svg" alt=""> Adicionar Diário</button>
    </form>
  </div>

  <div *ngIf="diarios && diarios.length > 0" class="diarios-display">
    <h4>Diários Registrados</h4>
    <ul>
      <li *ngFor="let diario of diarios">
        <span>{{ diario.data | date:'dd/MM/yyyy' }} - Clima: {{ getClimaName(diario.clima) }}</span>
        <div class="diario-actions">
          <button (click)="viewDiarioDetails(diario.id)" class="btn-view-details"><img src="img/descriptionIcon.svg" alt=""> Ver Detalhes</button>
          <button *ngIf="canManageDiarios" (click)="deleteDiario(diario.id)" class="btn-delete-diario"><img src="img/trashIcon.svg" alt=""> Excluir</button>
        </div>
      </li>
    </ul>
  </div>

  <div *ngIf="!diarios || diarios.length === 0 && !loading" class="no-data-message">
    Nenhum diário de obra registrado para esta obra.
  </div>

  <!-- Diario Details Modal/Section -->
  <div *ngIf="currentDiarioDetalhes" class="diario-details-modal">
    <div class="modal-content">
      <button class="btn-close" (click)="closeDiarioDetails()">X</button>
      <h4>Detalhes do Diário de {{ currentDiarioDetalhes.data | date:'dd/MM/yyyy' }}</h4>
      <p><strong>Clima:</strong> {{ getClimaName(currentDiarioDetalhes.clima) }}</p>
      <p><strong>Quantidade de Colaboradores:</strong> {{ currentDiarioDetalhes.quantidadeColaboradores }}</p>
      <p><strong>Atividades:</strong> {{ currentDiarioDetalhes.descricaoAtividades }}</p>
      <p *ngIf="currentDiarioDetalhes.observacoes"><strong>Observações:</strong> {{ currentDiarioDetalhes.observacoes }}</p>

      <h5>Foto</h5>
      <div *ngIf="currentDiarioPhotoUrl" class="photo-item">
        <img [src]="currentDiarioPhotoUrl" alt="Foto do Diário" style="max-width: 100%; height: auto;">
      </div>
      <p *ngIf="!currentDiarioPhotoUrl">Nenhuma foto.</p>

      <h5>Comentários</h5>
      <div *ngIf="canManageDiarios" class="comment-input-area">
        <textarea [(ngModel)]="newComentarioTexto" placeholder="Escreva um comentário..." rows="3"></textarea>
        <button (click)="addComentario(currentDiarioDetalhes.id)" class="btn-add-comment"><img src="img/sendIcon.svg" alt=""> Comentar</button>
      </div>
      <div class="comments-list">
        <div *ngFor="let comentario of currentDiarioDetalhes.comentarios" class="comment-card">
          <div class="comment-header">
            <span class="comment-author"><strong>{{ comentario.autorNome }}</strong></span>
            <span class="comment-date">{{ comentario.data | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
          <p class="comment-text">{{ comentario.texto }}</p>
          <div class="comment-actions">
            <button *ngIf="canManageDiarios" (click)="deleteComentario(currentDiarioDetalhes.id, comentario.id)" class="btn-delete-comment"><img src="img/trashIcon.svg" alt=""></button>
          </div>
        </div>
      </div>
      <p *ngIf="!currentDiarioDetalhes.comentarios || currentDiarioDetalhes.comentarios.length === 0">Nenhum comentário.</p>
    </div>
  </div>
</div>